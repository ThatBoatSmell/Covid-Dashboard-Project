---
title: "demographics"
output: html_notebook
---

# Load Libraries
```{r}
library(tidyverse)
library(janitor)
```

# Read In Data
```{r}
admission_demographics <- read_csv("data/inpatient_and_daycase_by_nhs_board_of_treatment_age_and_sex.csv")

admission_deprivation <- read_csv("data/activity_by_board_of_treatment_and_deprivation.csv")
```

# Data Cleaning

## Clean Variable Names 
```{r}
admission_demographics_clean <- admission_demographics %>% clean_names()

admission_deprivation_clean <- admission_deprivation %>% clean_names()
```

## Select Required Variables
```{r}
admission_demographics_clean <- admission_demographics_clean %>% 
  select(quarter, hb, location, admission_type, sex, age, episodes, 
         length_of_episode, average_length_of_episode, stays,
         length_of_stay, average_length_of_stay)

admission_deprivation_clean <- admission_deprivation_clean %>% 
  select(quarter, hb, location, admission_type, simd, episodes, 
         length_of_episode, average_length_of_episode, stays,
         length_of_stay, average_length_of_stay)
```

## Add Health Board Names

```{r}
admission_demographics_clean <- admission_demographics_clean %>% 
  mutate(hb = ifelse(hb == "S08000015", "Ayrshire and Arran", hb),
         hb = ifelse(hb == "S08000016", "Borders", hb),
         hb = ifelse(hb == "S08000017", "Dumfries and Galloway", hb),
         hb = ifelse(hb == "S08000018", "Fife", hb),
         hb = ifelse(hb == "S08000019", "Forth Valley", hb),
         hb = ifelse(hb == "S08000020", "Grampian", hb),
         hb = ifelse(hb == "S08000021", "Greater Glasgow and Clyde", hb),
         hb = ifelse(hb == "S08000022", "Highland", hb),
         hb = ifelse(hb == "S08000023", "Lanarkshire", hb),
         hb = ifelse(hb == "S08000024", "Lothian", hb),
         hb = ifelse(hb == "S08000025", "Orkney", hb),
         hb = ifelse(hb == "S08000026", "Shetland", hb),
         hb = ifelse(hb == "S08000027", "Tayside", hb),
         hb = ifelse(hb == "S08000028", "Western Isles", hb),
         hb = ifelse(hb == "S08000029", "Fife", hb),
         hb = ifelse(hb == "S08000030", "Tayside", hb),
         hb = ifelse(hb == "S08000031", "Greater Glasgow and Clyde", hb),
         hb = ifelse(hb == "S08000032", "Lanarkshire", hb),
         hb = ifelse(hb == "S92000003", "All of Scotland", hb),
         hb = ifelse(hb == "S27000001", "Non-NHS Provider", hb),
         hb = ifelse(hb == "SB0801", "The Golden Jubilee National Hospital", hb),
         hb = ifelse(hb == "SN0811", "National Facility NHS Louisa Jordan", hb)
         ) %>%
  rename(nhs_health_board = hb)

admission_deprivation_clean <- admission_deprivation_clean %>% 
  mutate(hb = ifelse(hb == "S08000015", "Ayrshire and Arran", hb),
         hb = ifelse(hb == "S08000016", "Borders", hb),
         hb = ifelse(hb == "S08000017", "Dumfries and Galloway", hb),
         hb = ifelse(hb == "S08000018", "Fife", hb),
         hb = ifelse(hb == "S08000019", "Forth Valley", hb),
         hb = ifelse(hb == "S08000020", "Grampian", hb),
         hb = ifelse(hb == "S08000021", "Greater Glasgow and Clyde", hb),
         hb = ifelse(hb == "S08000022", "Highland", hb),
         hb = ifelse(hb == "S08000023", "Lanarkshire", hb),
         hb = ifelse(hb == "S08000024", "Lothian", hb),
         hb = ifelse(hb == "S08000025", "Orkney", hb),
         hb = ifelse(hb == "S08000026", "Shetland", hb),
         hb = ifelse(hb == "S08000027", "Tayside", hb),
         hb = ifelse(hb == "S08000028", "Western Isles", hb),
         hb = ifelse(hb == "S08000029", "Fife", hb),
         hb = ifelse(hb == "S08000030", "Tayside", hb),
         hb = ifelse(hb == "S08000031", "Greater Glasgow and Clyde", hb),
         hb = ifelse(hb == "S08000032", "Lanarkshire", hb),
         hb = ifelse(hb == "S92000003", "All of Scotland", hb),
         hb = ifelse(hb == "S27000001", "Non-NHS Provider", hb),
         hb = ifelse(hb == "SB0801", "The Golden Jubilee National Hospital", hb),
         hb = ifelse(hb == "SN0811", "National Facility NHS Louisa Jordan", hb)
         ) %>%
  rename(nhs_health_board = hb)

```

## Create Separate Year and Quarter Columns

```{r}
admission_demographics_clean <- admission_demographics_clean %>% 
  separate(quarter,into = c("year", "quarter"), sep = "Q" )

admission_deprivation_clean <- admission_deprivation_clean %>% 
  separate(quarter,into = c("year", "quarter"), sep = "Q" )
```

## Update Age Data

```{r}
admission_demographics_clean <- admission_demographics_clean %>% 
  mutate(age = str_remove(age, "years"),
         age = str_remove(age, "and over"),
         age = str_trim(age),
         age = recode(age, "90" = "90 Plus"))
```


## Add Pre/Post Covid Column

```{r}
admission_demographics_clean <- admission_demographics_clean %>% 
  mutate(pre_post_2020 = ifelse(year %in% c("2017", "2018", "2019"),
                                "pre 2020", "post 2020"),
         pre_post_2020 = factor(pre_post_2020, 
                                levels = c("pre 2020", 
                                           "post 2020")))

admission_deprivation_clean <- admission_deprivation_clean %>% 
  mutate(pre_post_2020 = ifelse(year %in% c("2017", "2018", "2019"),
                                "pre 2020", "post 2020"),
         pre_post_2020 = factor(pre_post_2020, 
                                levels = c("pre 2020",
                                           "post 2020")))
```

## Drop NA Values

```{r}
admission_deprivation_clean <- admission_deprivation_clean %>%
  drop_na(simd)
```

## Set SIMD To Factor

```{r}
admission_deprivation_clean <- admission_deprivation_clean %>%
  mutate(simd = factor(simd, levels = c(1, 2, 3, 4, 5)))
```

## Filter for Required Data

```{r}
admission_demographics_all <- admission_demographics_clean %>%
  filter(nhs_health_board == "All of Scotland",
         admission_type == "All Inpatients")

admission_deprivation_all <- admission_deprivation_clean %>%
  filter(nhs_health_board == "All of Scotland",
         admission_type == "All Inpatients")
```


```{r}
admission_demographics_emergency <- admission_demographics_clean %>%
  filter(nhs_health_board == "All of Scotland",
         admission_type == "Emergency Inpatients")

admission_deprivation_emergency <- admission_deprivation_clean %>%
  filter(nhs_health_board == "All of Scotland",
         admission_type == "Emergency Inpatients")

```


# Visualisations

## Gender

### 1A. All In-Patients

```{r}
admission_demographics_all %>%
  group_by(quarter, sex, pre_post_2020) %>% 
  summarise(total_admissions = sum(episodes)) %>% 
  ggplot() +
  geom_col(aes(x = quarter, y = total_admissions, fill = sex),
           position = "fill") +
  facet_wrap(~pre_post_2020) +
  labs(
    x = "\n Quarter",
    y = "Proportion of Episodes of Care \n",
    title = "Proportion of Episodes of Care by Gender & Quarter",
    fill = "Gender:")
```

Interpretation: Males and Females both make up ~50% of Episodes of Care both pre-2020 and post 2020.

### 1B. Emergency In-Patients

```{r}
admission_demographics_emergency %>%
  group_by(quarter, sex, pre_post_2020) %>% 
  summarise(total_admissions = sum(episodes)) %>% 
  ggplot() +
  geom_col(aes(x = quarter, y = total_admissions, fill = sex),
           position = "fill") +
  facet_wrap(~pre_post_2020) +
  labs(
    x = "\n Quarter",
    y = "Proportion of Episodes of Care \n",
    title = "Proportion of Episodes of Care by Gender & Quarter",
    fill = "Gender:")
```

### 2A. All In-Patients

```{r}
admission_demographics_all %>%
  ggplot() +
  geom_col(aes(x = quarter, y = average_length_of_stay, fill = sex),
           position = "dodge") +
  facet_grid(~pre_post_2020) +
  labs(
    x = "\n Quarter",
    y = "Proportion of Admissions \n",
    title = "Average Length of Stay by Gender & Quarter",
    fill = "Gender:")
```

Interpretation: 
- Females have a longer mean length of stay in each quarter both pre-2020 and post 2020.
- Females mean length of stay increased in all quarters post-2020. 
- Males mean length of stay increased in Q2, but other wise stayed much the same.

### 2B. Emergency In-Patients

```{r}
admission_demographics_emergency %>%
  ggplot() +
  geom_col(aes(x = quarter, y = average_length_of_stay, fill = sex),
           position = "dodge") +
  facet_grid(~pre_post_2020) +
  labs(
    x = "\n Quarter",
    y = "Proportion of Admissions \n",
    title = "Average Length of Stay by Gender & Quarter",
    fill = "Gender:")
```


## Age

### 1.

```{r}

# User Input(s): Year (Single Select) & Age (Multi-Select)

admission_demographics_all %>%
  filter(year == "2019",
         age %in% c("10-19", "20-29", "70-79", "80-89")) %>% 
  group_by(quarter, age) %>% 
  summarise(total_admissions = sum(episodes)) %>% 
  ggplot(aes(x = quarter, y = total_admissions)) +
  geom_point(aes(colour = age)) +
  geom_line(aes(group = age, colour = age)) +
  labs(
    x = "\n Quarter",
    y = "Number of Episodes of Care \n",
    title = "Mean Episodes of Care by Age & Quarter",
    colour = "Age:")

```

### 2A. All In-Patients

```{r}

# User Input(s): Age (Multi-Select)

admission_demographics_all %>%
  filter(age %in% c("10-19", "20-29", "30-39", "40-49", 
                    "50-50", "60-69", "70-79", "80-89",
                    "90 Plus")) %>% 
  group_by(quarter, age, pre_post_2020) %>%
  summarise(mean_length_of_stay = mean(average_length_of_stay)) %>% 
  ggplot(aes(x = quarter, y = mean_length_of_stay)) +
  geom_point(aes(colour = age)) +
  geom_line(aes(group = age, colour = age)) +
  facet_wrap(~pre_post_2020) +
  labs(
    x = "\n Quarter",
    y = "Mean Length of Stay \n",
    title = "Mean Length of Stay by Age & Quarter",
    colour = "Age:")  
  
```

Interpretation: 
- Both pre and post 2020 Elderly age groups have a greater mean length of stay than younger age groups.
- Pre 2020: Elderly age groups have the longest mean length of stay in Q1, with the mean length stay of younger age groups staying fairly uniform throughout the year.
- Post 2020: Elderly age groups still have the longest mean length of stay in Q1, however there is a greater difference between Q1 and other quarters than previously. Younger age groups also show some increase in Q4.

### 2B. Emergency In-Patients

```{r}
admission_demographics_emergency %>%
  filter(age %in% c("10-19", "20-29", "30-39", "40-49", 
                    "50-50", "60-69", "70-79", "80-89",
                    "90 Plus")) %>% 
  group_by(quarter, age, pre_post_2020) %>%
  summarise(mean_length_of_stay = mean(average_length_of_stay)) %>% 
  ggplot(aes(x = quarter, y = mean_length_of_stay)) +
  geom_point(aes(colour = age)) +
  geom_line(aes(group = age, colour = age)) +
  facet_wrap(~pre_post_2020) +
  labs(
    x = "\n Quarter",
    y = "Mean Length of Stay \n",
    title = "Mean Length of Stay by Age & Quarter",
    colour = "Age:") 
```

### 3A. All In-Patients

```{r}

# User Input(s): Age (Multi-Select)

admission_demographics_all %>%
  filter(age %in% c("10-19", "20-29", "30-39", "40-49", 
                    "50-50", "60-69", "70-79", "80-89",
                    "90  Plus")) %>% 
  group_by(quarter, age, pre_post_2020) %>% 
  summarise(mean_admissions = mean(episodes)) %>% 
  ggplot(aes(x = quarter, y = mean_admissions)) +
  geom_point(aes(colour = age)) +
  geom_line(aes(group = age, colour = age)) +
  facet_wrap(~pre_post_2020) +
    labs(
    x = "\n Quarter",
    y = "Mean Episodes of Care \n",
    title = "Mean Episodes of Care by Age & Quarter",
    colour = "Age:")

```

Interpretation: 
- Both pre and post 2020 Elderly age groups have a greater mean number of episodes of care than younger age groups.
- Pre 2020: Elderly age groups see an increase of episodes of care in Q4, with the younger age groups staying fairly uniform throughout the year.
- Post 2020: The number of episodes of care across all ages is reduced and we do not see the same increase in elderly episodes of care in Q4.


### 3B. Emergency In-Patients

```{r}
admission_demographics_emergency %>%
  filter(age %in% c("10-19", "20-29", "30-39", "40-49", 
                    "50-50", "60-69", "70-79", "80-89",
                    "90  Plus")) %>% 
  group_by(quarter, age, pre_post_2020) %>% 
  summarise(mean_admissions = mean(episodes)) %>% 
  ggplot(aes(x = quarter, y = mean_admissions)) +
  geom_point(aes(colour = age)) +
  geom_line(aes(group = age, colour = age)) +
  facet_wrap(~pre_post_2020) +
    labs(
    x = "\n Quarter",
    y = "Mean Episodes of Care \n",
    title = "Mean Episodes of Care by Age & Quarter",
    colour = "Age:")
```

## Deprivation

### 1A. All In-Patients

```{r}

# User Input(s): SIMD/Deprivation (Multi-Select)

# Scottish Index of Multiple Deprivation (SIMD);
# 1 (Most Deprived) -> 5 (Least Deprived)

admission_deprivation_all %>%
  filter(simd %in% c("1", "2", "3", "4", "5")) %>% 
  group_by(quarter, simd, pre_post_2020) %>% 
  summarise(mean_episodes = mean(episodes)) %>% 
  ggplot(aes(x = quarter, y = mean_episodes)) +
  geom_point(aes(colour = simd)) +
  geom_line(aes(group = simd, colour = simd)) +
  facet_wrap(~pre_post_2020) +
    labs(
    x = "\n Quarter",
    y = "Mean Episodes of Care \n",
    title = "Mean Episodes of Care by SIMD & Quarter",
    colour = "SIMD:")
```

Interpretation: 
- Most deprived = most episodes of care.
- Post 2020: Increase in all levels in Q4.
- Post 2021: No increase in Q4.

### 1B. Emergency In-Patients

```{r}

# User Input(s): SIMD/Deprivation (Multi-Select)

admission_deprivation_emergency %>%
  filter(simd %in% c("1", "2", "3", "4", "5")) %>% 
  group_by(quarter, simd, pre_post_2020) %>% 
  summarise(mean_episodes = mean(episodes)) %>% 
  ggplot(aes(x = quarter, y = mean_episodes)) +
  geom_point(aes(colour = simd)) +
  geom_line(aes(group = simd, colour = simd)) +
  facet_wrap(~pre_post_2020) +
    labs(
    x = "\n Quarter",
    y = "Mean Episodes of Care \n",
    title = "Mean Episodes of Care by SIMD & Quarter",
    colour = "SIMD:")
```


### 2A. All In-Patients

```{r}

# User Input(s): SIMD/Deprivation (Multi-Select)

admission_deprivation_all %>%
  filter(simd %in% c("1", "2", "3", "4", "5")) %>% 
  group_by(quarter, simd, pre_post_2020) %>% 
  summarise(mean_length_of_stay = mean(average_length_of_stay)) %>% 
  ggplot(aes(x = quarter, y = mean_length_of_stay)) +
  geom_point(aes(colour = simd)) +
  geom_line(aes(group = simd, colour = simd)) +
  facet_wrap(~pre_post_2020) +
    labs(
    x = "\n Quarter",
    y = "Mean Length of Stay \n",
    title = "Mean Length of Stay by SIMD & Quarter",
    colour = "SIMD:")

```

Interpretation: 
- Pre & Post 2020: Mean length of stay is variable across quarters, although all levels show an increase from Q3 to Q4.
- Post 2021: Mean length of stay hgher across all levels.
- Post 2021: Q1 the highest mean length of saty for all levels and for most levels except 5 and increase from Q3 to Q4

### 2B. Emergency In-Patients

```{r}

# User Input(s): SIMD/Deprivation (Multi-Select)

admission_deprivation_emergency %>%
  filter(simd %in% c("1", "2", "3", "4", "5")) %>% 
  group_by(quarter, simd, pre_post_2020) %>% 
  summarise(mean_length_of_stay = mean(average_length_of_stay)) %>% 
  ggplot(aes(x = quarter, y = mean_length_of_stay)) +
  geom_point(aes(colour = simd)) +
  geom_line(aes(group = simd, colour = simd)) +
  facet_wrap(~pre_post_2020) +
    labs(
    x = "\n Quarter",
    y = "Mean Length of Stay \n",
    title = "Mean Length of Stay by SIMD & Quarter",
    colour = "SIMD:")
```

